{"version":3,"sources":["../../src/middlewares/auth.middleware.ts"],"sourcesContent":["import { NextFunction, Response } from 'express';\r\nimport { verify } from 'jsonwebtoken';\r\nimport { SECRET_KEY } from '@config';\r\nimport { HttpException } from '@exceptions/HttpException';\r\nimport { DataStoredInToken, RequestWithUser } from '@interfaces/auth.interface';\r\nimport { initializeDbConnection } from '@/app';\r\n\r\nconst authMiddleware = async (req: RequestWithUser, res: Response, next: NextFunction) => {\r\n  const Authorization = req.cookies['Authorization'] || (req.header('Authorization') ? req.header('Authorization').split('Bearer ')[1] : null);\r\n  const authMiddlewareSession = initializeDbConnection().session();\r\n  if (Authorization) {\r\n    try {\r\n      const secretKey: string = SECRET_KEY;\r\n      const verificationResponse = (verify(Authorization, secretKey)) as DataStoredInToken;\r\n\r\n      const userId = verificationResponse.id;\r\n      console.log(verificationResponse);\r\n\r\n      const foundUser = await authMiddlewareSession.executeRead(tx => tx.run('match (u:user {id: $userId}) return u', {\r\n        userId: userId\r\n      }));\r\n\r\n      if (foundUser.records.length > 0) {\r\n        next();\r\n      } else {\r\n        next(new HttpException(400, 'Wrong authentication token'));\r\n      }\r\n    } catch (error) {\r\n      console.log(error);\r\n      next(new HttpException(401, 'missing token'));\r\n    }\r\n  } else {\r\n    next(new HttpException(400, 'Authentication token missing'));\r\n  }\r\n};\r\n\r\nexport default authMiddleware;\r\n"],"names":["authMiddleware","req","res","next","Authorization","cookies","header","split","authMiddlewareSession","initializeDbConnection","session","secretKey","SECRET_KEY","verificationResponse","verify","userId","id","console","log","foundUser","executeRead","tx","run","records","length","HttpException","error"],"mappings":";;;;+BAoCA;;;eAAA;;;8BAnCuB;wBACI;+BACG;qBAES;AAEvC,MAAMA,iBAAiB,OAAOC,KAAsBC,KAAeC;IACjE,MAAMC,gBAAgBH,IAAII,OAAO,CAAC,gBAAgB,IAAKJ,CAAAA,IAAIK,MAAM,CAAC,mBAAmBL,IAAIK,MAAM,CAAC,iBAAiBC,KAAK,CAAC,UAAU,CAAC,EAAE,GAAG,IAAG;IAC1I,MAAMC,wBAAwBC,IAAAA,2BAAsB,IAAGC,OAAO;IAC9D,IAAIN,eAAe;QACjB,IAAI;YACF,MAAMO,YAAoBC,kBAAU;YACpC,MAAMC,uBAAwBC,IAAAA,oBAAM,EAACV,eAAeO;YAEpD,MAAMI,SAASF,qBAAqBG,EAAE;YACtCC,QAAQC,GAAG,CAACL;YAEZ,MAAMM,YAAY,MAAMX,sBAAsBY,WAAW,CAACC,CAAAA,KAAMA,GAAGC,GAAG,CAAC,yCAAyC;oBAC9GP,QAAQA;gBACV;YAEA,IAAII,UAAUI,OAAO,CAACC,MAAM,GAAG,GAAG;gBAChCrB;YACF,OAAO;gBACLA,KAAK,IAAIsB,4BAAa,CAAC,KAAK;YAC9B;QACF,EAAE,OAAOC,OAAO;YACdT,QAAQC,GAAG,CAACQ;YACZvB,KAAK,IAAIsB,4BAAa,CAAC,KAAK;QAC9B;IACF,OAAO;QACLtB,KAAK,IAAIsB,4BAAa,CAAC,KAAK;IAC9B;AACF;MAEA,WAAezB"}